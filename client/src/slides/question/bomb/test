import { useState, useEffect } from "react";
import { Participant } from "@/models/Quiz";
import Avatar, { genConfig } from "react-nice-avatar";
import { motion, AnimatePresence } from "framer-motion";
import { HeartIcon } from "lucide-react";

type BombTimerProps = {
  initialTime: number;
  participants: Participant[];
};

const BombTimer = ({ initialTime, participants }: BombTimerProps) => {
  const [time, setTime] = useState(initialTime);
  const [currentParticipants, setCurrentParticipants] = useState(participants);
  const [participantHearts, setParticipantHearts] = useState(
    Object.fromEntries(participants.map((p) => [p.name, 3]))
  );
  const [deadParticipants, setDeadParticipants] = useState<Participant[]>([]);
  const [winner, setWinner] = useState<Participant | null>(null);

  // Countdown effect
  useEffect(() => {
    if (time <= 0 || winner) return;

    const timer = setInterval(() => {
      setTime((prevTime) => prevTime - 1);
    }, 1000);

    return () => clearInterval(timer);
  }, [time, winner]);

  // Handle "x" key press to rotate positions
  useEffect(() => {
    const handleKeyPress = (e: KeyboardEvent) => {
      if (e.key === "x" && currentParticipants.length > 1) {
        setCurrentParticipants((prevParticipants) => {
          const firstParticipant = prevParticipants[0];
          const newParticipants = [...prevParticipants.slice(1), firstParticipant];

          // Skip players with 0 hearts
          while (newParticipants[0] && participantHearts[newParticipants[0].name] === 0) {
            newParticipants.push(newParticipants.shift() as Participant);
          }

          return newParticipants;
        });
        setTime(initialTime);
      }
    };

    window.addEventListener("keydown", handleKeyPress);

    return () => {
      window.removeEventListener("keydown", handleKeyPress);
    };
  }, [initialTime, currentParticipants, participantHearts]);

  // Handle timer going to 0 and losing a heart
  useEffect(() => {
    if (time === 0) {
      const currentPlayer = currentParticipants[0];

      if (!currentPlayer) return;

      setParticipantHearts((prevHearts) => {
        const updatedHearts = { ...prevHearts };
        updatedHearts[currentPlayer.name] = Math.max(0, updatedHearts[currentPlayer.name] - 1);

        if (updatedHearts[currentPlayer.name] === 0) {
          // Move player to deadParticipants
          setDeadParticipants((prev) => [...prev, currentPlayer]);
          setCurrentParticipants((prevParticipants) => prevParticipants.filter((p) => p.name !== currentPlayer.name));
        }

        return updatedHearts;
      });

      setTime(initialTime);
    }
  }, [time, currentParticipants]);

  // Detect winner
  useEffect(() => {
    if (currentParticipants.length === 1) {
      setWinner(currentParticipants[0]);
    }
  }, [currentParticipants]);

  if (winner) {
    // Render the Winner Screen
    return (
      <motion.div
        style={{
          height: "100vh",
          display: "flex",
          flexDirection: "column",
          alignItems: "center",
          justifyContent: "center",
          gap: "2rem",
          textAlign: "center",
        }}
      >
        <h1 className="font-display text-6xl">Winner is {winner.name}!</h1>
        <Avatar
          style={{
            width: "12rem",
            height: "12rem",
          }}
          {...genConfig(winner.avatar)}
        />
      </motion.div>
    );
  }

  return (
    <motion.div
      style={{
        position: "relative",
        height: "100vh",
        display: "flex",
        flexDirection: "column",
        alignItems: "center",
        justifyContent: "center",
        gap: "2rem",
      }}
    >
      {/* Timer */}
      <div className="font-display text-5xl" style={{ textAlign: "center" }}>
        {time}
      </div>

      {/* Big Avatar */}
      <div>
        <AnimatePresence mode="wait">
          {currentParticipants[0] && (
            <motion.div
              key={currentParticipants[0].name}
              initial={{ opacity: 0, x: "-100%" }}
              animate={{ opacity: 1, x: "0%" }}
              exit={{ opacity: 0, y: "+100%" }}
              transition={{ duration: 0.35, ease: "easeInOut" }}
              style={{
                display: "flex",
                flexDirection: "column",
                alignItems: "center",
                textAlign: "center",
                zIndex: 2,
              }}
            >
              <Avatar
                style={{
                  width: "12rem",
                  height: "12rem",
                }}
                {...genConfig(currentParticipants[0].avatar)}
              />
              <h3 className="font-display">{currentParticipants[0].name}</h3>
              <div style={{ display: "flex", gap: "0.5rem" }}>
                {Array.from({ length: participantHearts[currentParticipants[0].name] || 0 }).map((_, index) => (
                  <HeartIcon key={index} fill="#FF4545" color="#FF4545" />
                ))}
                {participantHearts[currentParticipants[0].name] === 0 && <span>ğŸ’€</span>}
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </div>

      {/* Avatar Row */}
      <motion.div
        style={{
          display: "flex",
          justifyContent: "center",
          alignItems: "center",
          gap: "2rem",
          width: "100%",
          padding: "1rem 2rem",
          overflow: "hidden",
        }}
      >
        {participants.map((participant) => (
          <motion.div
            key={participant.name}
            initial={{ opacity: 0, scale: 0.8 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ duration: 0.5, ease: "easeInOut" }}
            style={{
              display: "flex",
              flexDirection: "column",
              alignItems: "center",
              textAlign: "center",
              filter: deadParticipants.some((p) => p.name === participant.name) ? "grayscale(100%)" : "none",
            }}
          >
            <Avatar
              style={{
                width: "8rem",
                height: "8rem",
              }}
              {...genConfig(participant.avatar)}
            />
            <h3 className="font-display">{participant.name}</h3>
            <div style={{ display: "flex", gap: "0.5rem" }}>
              {participantHearts[participant.name] > 0
                ? Array.from({ length: participantHearts[participant.name] }).map((_, index) => (
                    <HeartIcon key={index} fill="#FF4545" color="#FF4545" />
                  ))
                : "ğŸ’€"}
            </div>
          </motion.div>
        ))}
      </motion.div>
    </motion.div>
  );
};

export default BombTimer;
